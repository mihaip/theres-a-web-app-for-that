<!DOCTYPE html>
<html>
  <head>
    <script src="app-data.js"></script>
    <script src="app.js"></script>
    <title>There's an app for that</title>
    <style>
      body {
        font-family: Helvetica, sans-serif;
        font-size: 13px;
        margin: 0;
      }

      h1 {
        margin-top: 0;
        background: #eee;
        padding: .5em;
        border-bottom: solid 1px #ccc;
      }

      .container {
        margin: 8px;
      }

      #loading-indicator {
        display: none;
      }

      .loading #loading-indicator {
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -15px;
        margin-left: -60px;
        width: 120px;
        height: 30px;
        font-family: Helvetica, Arial, sans-serif;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        background: #000;
        color: #fff;
        opacity: 0.5;
        border-radius: 10px;
        padding: 10px;
      }

      .loading #apps {
        display: none;
      }

      .app {
        text-align: center;
      }

      .app a {
        display: block;
        text-decoration: none;
        padding: 10px;
        border-radius: 10px;
        float: left;
        width: 160px;
        height: 160px;
        color: #333;
      }

      .app a:hover {
        background: #eee;
      }

      .app .title {
        padding-top: 2px;
        font-weight: bold;
      }

      .app .visits {
        color: #999;
        font-size: 90%;
      }
    </style>
  </head>
  <body class="loading">
    <h1>There's an app for that</h1>
    <div id="loading-indicator">Loading...</div>

    <div class="container">
      <div id="apps">
      </div>
    </div>

    <script>
      var appCellsByAppId = {};
      function displayApp(app, historyItem) {
        document.body.classList.remove('loading');
        if (app.appId in appCellsByAppId) {
          var appCell = appCellsByAppId[app.appId];
          appCell.visitCount++;
          appCell.visitCountNode.textContent = appCell.visitCount + ' visits';
          return;
        }

        var appCell = appCellsByAppId[app.appId] = {
          node: document.createElement('div'),
          visitCount: 1,
          visitCountNode: document.createElement('div')
        };

        appCell.node.classList.add('app');

        var appLinkNode = document.createElement('a');
        appLinkNode.href = app.getStoreUrl();
        appLinkNode.target = '_blank';
        appCell.node.appendChild(appLinkNode);

        var appIconNode = document.createElement('img');
        appIconNode.width = 128;
        appIconNode.height = 128;
        appIconNode.src = app.iconUrl;
        appLinkNode.appendChild(appIconNode);

        var appTitleNode = document.createElement('div');
        appTitleNode.classList.add('title');
        appTitleNode.textContent = app.title;
        appLinkNode.appendChild(appTitleNode);

        appCell.visitCountNode.classList.add('visits');
        appCell.visitCountNode.textContent = '1 visit';
        appLinkNode.appendChild(appCell.visitCountNode);

        document.getElementById('apps').appendChild(appCell.node);
      }

      function processHistoryItems(startIndex, historyItems) {
        var endIndex = startIndex + 1000;
        var isLastChunk = false;
        if (endIndex > historyItems.length) {
          isLastChunk = true;
          endIndex = historyItems.length;
        }
        for (var i = startIndex; i < endIndex; i++) {
          var historyItem = historyItems[i];
          var app = App.fromUrl(historyItem.url);
          if (app) displayApp(app, historyItem)
        }

        if (!isLastChunk)
          setTimeout(processHistoryItems.bind(this, endIndex, historyItems), 0);
      }

      // TOOD(mihaip): re-visit chrome.history.search parameters
      chrome.history.search({
          'text': '',
          'maxResults': 1000000000,
          'startTime': 0
      },
      processHistoryItems.bind(this, 0));
    </script>
  </head>
</html>
